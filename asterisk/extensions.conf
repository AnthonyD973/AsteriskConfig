[globals]
; Specific to extensions.conf
MAIN_EXTEN = @MAIN_EXTEN@
VOICEMAIL_EXTEN = *${MAIN_EXTEN}
EXTENSION_LIST=@EXTENSION_LIST@
DIAL_TIME_SEC=20

; Voip.ms account
CALLER_NAME = @CALLER_NAME@
DID_NUMBER = @DID_NUMBER@
VOIPMS_ACCOUNT_ID = @VOIPMS_ACCOUNT_ID@
VOIPMS_SERVER = @VOIPMS_SERVER@

; ==============================================
; =                 SUBROUTINES                =
; ==============================================

; Returns 1 if endpoint is present, 0 if it is not or
; does not exist.
[isDevicePresent]
exten => s,1,Set(DEVICE=${ARG1})
same  => n,Return(${REGEX("UNKNOWN|NOT_INUSE|INUSE|BUSY|RINGING|RINGINUSE|ONHOLD","${DEVICE_STATE(${DEVICE})}")})

[generateDialString]
exten => s,1,Set(exten_list=${EXTENSION_LIST})
same  => n,Set(dialString=)
same  => n,While($["${SET(exten=${SHIFT(exten_list)})}" != ""])
; Do not even try to dial if the device is not present.
same  => n,Gosub(isDevicePresent,s,1(${exten}))
same  => n,GotoIf($[!${GOSUB_RETVAL}]?loop-end)
same  => n,Set(dialString=${dialString}&${exten})
same  => n(loop-end),EndWhile()
same  => n,Set(dialString=${dialString:1})
same  => n,Return(${dialString})

[sendSmsToEndpoints]
exten => s,1,NoOp(Sending SMS messages to all extensions...)
same  => n,Set(exten_list=${EXTENSION_LIST})
same  => n,Set(received_by=)
; Loop on all extensions
same  => n,While($["${SET(exten=${SHIFT(exten_list)})}" != ""])
same  => n,Set(chan=${CUT(exten,/,1)})
same  => n,Set(endpoint=${CUT(exten,/,2)})
; If device is not present, do not even try to send
; the message.
same  => n,Gosub(isDevicePresent,s,1(${exten}))
same  => n,GotoIf($[!${GOSUB_RETVAL}]?loop-end)
; Try to send the message
same  => n,MessageSend(${TOLOWER(${chan})}:${endpoint}@${HOST_TO},${ACTUAL_FROM})
same  => n,NoOp(${MESSAGE_SEND_STATUS})
same  => n,GotoIf($["${MESSAGE_SEND_STATUS}" != "SUCCESS"]?loop-end)
; If the message was not sent or the device is not present,
; the message was not received.
same  => n,Set(received_by=${received_by},${chan}/${endpoint})
same  => n(loop-end),EndWhile()
same  => n,Set(received_by=${received_by:1}
; Finally, return the list of devices that received the
; message.
same  => n,Return(${received_by})

[dialEndpoints]
exten => s,1,NoOp(Dialing endpoint...)
same  => n,Gosub(generateDialString,s,1)
same  => n,Set(dialString=${GOSUB_RETVAL})
same  => n,GotoIf($["${dialString}" == ""]?return)
same  => n,Dial(${dialString})
same  => n(return),Return()

; ==============================================
; =                  DIALPLAN                  =
; ==============================================

[phones]
; Test if trying to send text message between extensions, and, if so,
; jump to appropriate context.
exten => ${MAIN_EXTEN},1,GotoIf($["${MESSAGE(to)}" != ""]?sms-in,${EXTEN},1)
same  => n,Gosub(dialEndpoints,s,1)
same  => n,VoiceMail(${EXTEN})
same  => n,Hangup()

exten => ${VOICEMAIL_EXTEN},1,VoiceMailMain(${EXTEN:1})
same  => n,Hangup()

include => voipms-inbound
include => voipms-outbound

[voipms-outbound]
exten => _1NXXNXXXXXX,1,Set(CALLERID(all)="${CALLER_NAME}" <${DID_NUMBER}>)
; Test if instant message, and, if so, jump to appropriate context.
same  => n,GotoIf($["${MESSAGE(to)}" != ""]?sms-out,${EXTEN:1},1)
same  => n,Dial(PJSIP/${EXTEN}@voipms)
same  => n,Hangup()

exten => _NXXNXXXXXX,1,Goto(voipms-outbound,1${EXTEN},1)

exten => _011.,1,Dial(PJSIP/${EXTEN}@voipms)
same  => n,Hangup()

exten => _00.,1,Dial(PJSIP/${EXTEN}@voipms)
same  => n,Hangup()

[voipms-inbound]
; Voip.MS uses extension "s" when sending
; us an SMS.
exten => s,1,Goto(sms-in,${MAIN_EXTEN},1)

exten => voipms,1,GotoIf($["${MESSAGE(from)" != ""]?sms-in,${MAIN_EXTEN},1)
same  => n,Goto(phones,${MAIN_EXTEN},1)

[sms-out]
exten => _NXXNXXXXXX,1,NoOp(Outbound Message dialplan invoked)
same  => n,Set(CALLERID(name)="${DID_NUMBER}")
same  => n,NoOp(To ${MESSAGE(to)})
same  => n,NoOp(From ${MESSAGE(from)})
same  => n,NoOp(Body ${MESSAGE(body)})
same  => n,Set(NUMBER_FROM=${CUT(CUT(MESSAGE(from),@,1),:,2)})
same  => n,Set(NUMBER_TO=${CUT(CUT(MESSAGE(to),@,1),:,2)})
same  => n,Set(ACTUAL_FROM="${DID_NUMBER}" <sip:${VOIPMS_ACCOUNT_ID}@montreal.voip.ms>)
same  => n,Set(ACTUAL_TO=pjsip:voipms/sip:${NUMBER_TO}@montreal.voip.ms>)
same  => n,MessageSend(${ACTUAL_TO},${ACTUAL_FROM})
same  => n,NoOp(Send status is ${MESSAGE_SEND_STATUS})
same  => n,Hangup()

[sms-in]
exten => _.,1,NoOp(Inbound SMS dialplan invoked)
same  => n,Set(NUMBER_TO=${EXTEN})
same  => n,Set(HOST_TO=${CUT(MESSAGE(to),@,2)})
same  => n,Set(ACTUAL_FROM=${MESSAGE(from)})
same  => n,GoSub(sendSmsToEndpoints,s,1)
same  => n,NoOp(Send status is ${MESSAGE_SEND_STATUS})
same  => n,UserEvent(SmsReceived,ReceivedBy:"PJSIP/linux,SIP/foobar")
same  => n,Hangup()

